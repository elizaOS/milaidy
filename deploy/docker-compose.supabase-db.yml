# Local Postgres for Milaidy using Supabase's Postgres image.
#
# Milaidy only needs a PostgreSQL database (plugin-sql). You do NOT need the
# full Supabase stack (auth/rest/realtime/storage) unless you want Studio.
#
# Usage:
#   docker compose -f deploy/docker-compose.supabase-db.yml up -d
#   # then set in ~/.milaidy/milaidy.json:
#   #   database.provider = "postgres"
#   #   database.postgres.connectionString = "postgresql://postgres:postgres@localhost:54322/milaidy"
#
services:
  milaidy-db:
    # If this tag ever fails to pull, try: supabase/postgres:latest
    image: supabase/postgres:15.1.0.147
    container_name: milaidy-db
    restart: unless-stopped
    ports:
      - "54322:5432"
    environment:
      POSTGRES_DB: milaidy
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - milaidy-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d milaidy"]
      interval: 5s
      timeout: 3s
      retries: 20

volumes:
  milaidy-db-data:
